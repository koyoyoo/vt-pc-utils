<template>
  <div class="aes-crypto-container">
    <!-- ÂØºËà™Ê†è -->
    <CpnNavigation />
    <div class="main-content">
      <div class="container">
        <!-- È°µÈù¢Â§¥ÈÉ® -->
        <CpnPageHeader
          title="AES Âä†ÂØÜËß£ÂØÜÂ∑•ÂÖ∑"
          subtitle="‰ΩøÁî® AES ÁÆóÊ≥ïÂØπÊñáÊú¨ËøõË°åÂä†ÂØÜÂíåËß£ÂØÜÊìç‰Ωú"
        />

        <div class="crypto-content">
          <!-- ÂØÜÈí•ÂíåÈÖçÁΩÆËÆæÁΩÆÂå∫Âüü -->
          <div class="config-section">
            <el-card class="config-card">
              <template #header>
                <div class="card-header">
                  <el-icon><Setting /></el-icon>
                  <span>ÂØÜÈí•‰∏éÈÖçÁΩÆ</span>
                </div>
              </template>

              <el-form
                :model="configForm"
                label-width="70px"
                label-position="left"
              >
                <el-row :gutter="20">
                  <el-col :span="9">
                    <el-form-item label="ÂØÜÈí•">
                      <div class="key-input-group">
                        <el-input
                          v-model="secretKey"
                          placeholder="ËØ∑ËæìÂÖ•ÂØÜÈí•"
                          show-password
                          clearable
                          class="key-input"
                        >
                          <template #append>
                            <el-button
                              type="primary"
                              @click="generateRandomKey"
                            >
                              ÁîüÊàêÈöèÊú∫ÂØÜÈí•
                            </el-button>
                          </template>
                        </el-input>
                      </div>
                    </el-form-item>
                  </el-col>
                  <el-col :span="5">
                    <el-form-item label="Âä†ÂØÜÊ®°Âºè">
                      <el-select
                        v-model="encryptionMode"
                        placeholder="ÈÄâÊã©Âä†ÂØÜÊ®°Âºè"
                        class="full-width"
                      >
                        <el-option label="ECB - ÁîµÂ≠êÂØÜÁ†ÅÊú¨" value="ECB" />
                        <el-option label="CBC - ÂØÜÁ†ÅÂùóÈìæÊé•" value="CBC" />
                        <el-option label="CFB - ÂØÜÁ†ÅÂèçÈ¶à" value="CFB" />
                        <el-option label="OFB - ËæìÂá∫ÂèçÈ¶à" value="OFB" />
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="4">
                    <el-form-item label="Â°´ÂÖÖÊ®°Âºè">
                      <el-select
                        v-model="paddingMode"
                        placeholder="ÈÄâÊã©Â°´ÂÖÖÊ®°Âºè"
                        class="full-width"
                      >
                        <el-option label="Pkcs7" value="Pkcs7" />
                        <el-option label="AnsiX923" value="AnsiX923" />
                        <el-option label="Iso10126" value="Iso10126" />
                        <el-option label="ZeroPadding" value="ZeroPadding" />
                      </el-select>
                    </el-form-item>
                  </el-col>
                  <el-col :span="5">
                    <el-form-item label="ËæìÂá∫Ê†ºÂºè">
                      <el-select
                        v-model="outputFormat"
                        placeholder="ÈÄâÊã©ËæìÂá∫Ê†ºÂºè"
                        class="full-width"
                      >
                        <el-option label="Base64ÁºñÁ†Å" value="Base64" />
                        <el-option label="HexÁºñÁ†Å" value="Hex" />
                      </el-select>
                    </el-form-item>
                  </el-col>
                </el-row>
              </el-form>
            </el-card>
          </div>
        </div>

        <!-- Âä†ÂØÜËß£ÂØÜÊìç‰ΩúÂå∫Âüü -->
        <div class="operation-section">
          <div class="operation-left">
            <el-card class="operation-card">
              <template #header>
                <div class="card-header">
                  <span>ÂéüÊñáËæìÂÖ•</span>
                  <div class="header-actions">
                    <el-button @click="clearPlainText">Ê∏ÖÁ©∫</el-button>
                    <el-button
                      type="primary"
                      @click="encryptText"
                      :loading="isEncrypting"
                    >
                      üîí Âä†ÂØÜ
                    </el-button>
                  </div>
                </div>
              </template>
              <el-input
                v-model="plainText"
                type="textarea"
                :rows="12"
                placeholder="ËØ∑ËæìÂÖ•Ë¶ÅÂä†ÂØÜÁöÑÊñáÊú¨..."
                resize="none"
                class="text-area"
              />
            </el-card>
          </div>

          <div class="operation-right">
            <el-card class="operation-card">
              <template #header>
                <div class="card-header">
                  <span>ÂØÜÊñáËæìÂá∫</span>
                  <div class="header-actions">
                    <el-button @click="clearCipherText">Ê∏ÖÁ©∫</el-button>
                    <el-button @click="copyResult">Â§çÂà∂</el-button>
                    <el-button
                      type="success"
                      @click="decryptText"
                      :loading="isDecrypting"
                    >
                      üîì Ëß£ÂØÜ
                    </el-button>
                  </div>
                </div>
              </template>
              <el-input
                v-model="cipherText"
                type="textarea"
                :rows="12"
                placeholder="Âä†ÂØÜÂêéÁöÑÂØÜÊñáÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå..."
                resize="none"
                class="text-area"
              />
            </el-card>
          </div>
        </div>
      </div>
    </div>

    <!-- È°µËÑö -->
    <CpnFooter />
  </div>
</template>

<script setup lang="ts">
import { ref } from "vue";
import CpnPageHeader from "@/components/CpnPageHeader.vue";
import CpnNavigation from "@/components/CpnNavigation.vue";
import CpnFooter from "@/components/CpnFooter.vue";
import { useToast } from "@/composables/useToast";
import { Setting, Lock, Refresh } from "@element-plus/icons-vue";
import CryptoJS from "crypto-js";

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const secretKey = ref(""); // ÂØÜÈí•
const plainText = ref(""); // ÂéüÊñá
const cipherText = ref(""); // ÂØÜÊñá
const isEncrypting = ref(false); // Âä†ÂØÜÁä∂ÊÄÅ
const isDecrypting = ref(false); // Ëß£ÂØÜÁä∂ÊÄÅ

// È´òÁ∫ßÈÄâÈ°π
const encryptionMode = ref("CBC"); // Âä†ÂØÜÊ®°Âºè
const paddingMode = ref("Pkcs7"); // Â°´ÂÖÖÊ®°Âºè
const outputFormat = ref("Base64"); // ËæìÂá∫Ê†ºÂºè

// Ë°®ÂçïÊï∞ÊçÆÂØπË±°
const configForm = ref({
  secretKey: "",
  encryptionMode: "CBC",
  paddingMode: "Pkcs7",
  outputFormat: "Base64",
});

// Toast ÂÆû‰æã
const toast = useToast();

// ÁîüÊàêÈöèÊú∫ÂØÜÈí•
const generateRandomKey = () => {
  const randomKey = CryptoJS.lib.WordArray.random(16).toString();
  secretKey.value = randomKey;
  toast.success("ÈöèÊú∫ÂØÜÈí•Â∑≤ÁîüÊàê");
};

// Âä†ÂØÜÊñáÊú¨
const encryptText = async () => {
  if (!secretKey.value.trim()) {
    toast.error("ËØ∑ËæìÂÖ•ÂØÜÈí•");
    return;
  }

  if (!plainText.value.trim()) {
    toast.error("ËØ∑ËæìÂÖ•Ë¶ÅÂä†ÂØÜÁöÑÊñáÊú¨");
    return;
  }

  isEncrypting.value = true;

  try {
    // Ëé∑ÂèñÂä†ÂØÜÈÖçÁΩÆ
    const mode = (CryptoJS.mode as any)[encryptionMode.value];
    const padding = (CryptoJS.pad as any)[paddingMode.value];

    // ÊâßË°åÂä†ÂØÜ
    const encrypted = CryptoJS.AES.encrypt(plainText.value, secretKey.value, {
      mode: mode,
      padding: padding,
    });

    // Ê†πÊçÆËæìÂá∫Ê†ºÂºèËΩ¨Êç¢ÁªìÊûú
    if (outputFormat.value === "Base64") {
      cipherText.value = encrypted.toString();
    } else {
      cipherText.value = encrypted.ciphertext.toString(CryptoJS.enc.Hex);
    }

    toast.success("Âä†ÂØÜÊàêÂäü");
  } catch (error) {
    toast.error("Âä†ÂØÜÂ§±Ë¥•Ôºö" + (error as Error).message);
  } finally {
    isEncrypting.value = false;
  }
};

// Ëß£ÂØÜÊñáÊú¨
const decryptText = async () => {
  if (!secretKey.value.trim()) {
    toast.error("ËØ∑ËæìÂÖ•ÂØÜÈí•");
    return;
  }

  if (!cipherText.value.trim()) {
    toast.error("ËØ∑ËæìÂÖ•Ë¶ÅËß£ÂØÜÁöÑÂØÜÊñá");
    return;
  }

  isDecrypting.value = true;

  try {
    // Ëé∑ÂèñËß£ÂØÜÈÖçÁΩÆ
    const mode = (CryptoJS.mode as any)[encryptionMode.value];
    const padding = (CryptoJS.pad as any)[paddingMode.value];

    let decrypted;

    // Ê†πÊçÆËæìÂá∫Ê†ºÂºèÂ§ÑÁêÜÂØÜÊñá
    if (outputFormat.value === "Base64") {
      decrypted = CryptoJS.AES.decrypt(cipherText.value, secretKey.value, {
        mode: mode,
        padding: padding,
      });
    } else {
      // HexÊ†ºÂºèÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ
      const cipherParams = CryptoJS.lib.CipherParams.create({
        ciphertext: CryptoJS.enc.Hex.parse(cipherText.value),
      });
      decrypted = CryptoJS.AES.decrypt(cipherParams, secretKey.value, {
        mode: mode,
        padding: padding,
      });
    }

    const decryptedText = decrypted.toString(CryptoJS.enc.Utf8);

    if (!decryptedText) {
      throw new Error("Ëß£ÂØÜÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÂØÜÈí•ÂíåÂØÜÊñáÊòØÂê¶Ê≠£Á°Æ");
    }

    plainText.value = decryptedText;
    toast.success("Ëß£ÂØÜÊàêÂäü");
  } catch (error) {
    toast.error("Ëß£ÂØÜÂ§±Ë¥•Ôºö" + (error as Error).message);
  } finally {
    isDecrypting.value = false;
  }
};

// Â§çÂà∂ÁªìÊûú
const copyResult = async () => {
  if (!cipherText.value.trim()) {
    toast.error("Ê≤°ÊúâÂèØÂ§çÂà∂ÁöÑÂÜÖÂÆπ");
    return;
  }

  try {
    await navigator.clipboard.writeText(cipherText.value);
    toast.success("Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø");
  } catch (error) {
    toast.error("Â§çÂà∂Â§±Ë¥•");
  }
};

// Ê∏ÖÁ©∫ÂéüÊñá
const clearPlainText = () => {
  plainText.value = "";
};

// Ê∏ÖÁ©∫ÂØÜÊñá
const clearCipherText = () => {
  cipherText.value = "";
};
</script>

<style lang="scss" scoped>
.aes-crypto-container {
  padding-top: 60px; // ‰∏∫ÂØºËà™Ê†èÁïôÂá∫Á©∫Èó¥
  padding-bottom: 80px; // ‰∏∫È°µËÑöÁïôÂá∫Á©∫Èó¥
}
.main-content {
  padding: 40px 0;
}

.container {
  width: 1200px;
  margin: 0 auto;
}
.crypto-content {
  margin: 0 auto;
  display: flex;
  flex-direction: column;
}

.config-section {
  margin-bottom: 20px;
  .config-card {
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);

    .card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #2c3e50;
    }

    .key-input-group {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-grow: 1;
      .key-input {
        flex: 1;
      }
    }

    .full-width {
      width: 100%;
    }
  }
}

.operation-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;

  .operation-card {
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      color: #2c3e50;

      .header-actions {
        display: flex;
      }
    }

    .text-area {
      :deep(.el-textarea__inner) {
        border-radius: 8px;
        border: 2px solid #e1e8ed;
        font-family: "Consolas", "Monaco", monospace;
        font-size: 14px;
        line-height: 1.5;

        &:focus {
          border-color: #667eea;
          box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
      }
    }
  }
}

// ÂìçÂ∫îÂºèËÆæËÆ°
@media (max-width: 768px) {
  .aes-crypto-container {
    padding: 10px;
  }

  .operation-section {
    grid-template-columns: 1fr;
  }

  .key-input-group {
    flex-direction: column;
    align-items: stretch !important;
  }

  .config-section {
    .el-row {
      .el-col {
        margin-bottom: 10px;
      }
    }
  }
}
</style>
